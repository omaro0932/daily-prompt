<script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
<script>
  // Particle effects
  tsParticles.load("particles",{
    particles:{
      number:{value:60},
      size:{value:3,random:true},
      move:{speed:1.5,direction:"none",random:true,outModes:"out"},
      links:{enable:true,distance:150,opacity:0.3},
      color:{value:["#f093fb","#4facfe","#00f2c3"]},
      opacity:{value:0.6,random:true}
    }
  });
  
  // Enhanced prompts with categories
  const prompts = {
    creative: [
      "Design a new emoji that represents 2025",
      "Invent a new sport that combines two existing ones",
      "Create a superhero whose power is based on your favorite food",
      "Design your dream treehouse in 5 words",
      "Invent a holiday celebration for introverts"
    ],
    writing: [
      "Write a story that ends with: 'And that's why I never trust mirrors'",
      "Describe your morning routine as an epic adventure",
      "Write a love letter from your future self",
      "Create a haiku about your wifi connection",
      "Write the opening line of a bestselling novel"
    ],
    art: [
      "Draw your mood using only geometric shapes",
      "Create a logo for a company that sells bottled dreams",
      "Design a tattoo that tells your life story",
      "Sketch an alien's interpretation of human fashion",
      "Illustrate a sound using only colors"
    ],
    challenge: [
      "Explain quantum physics using only food metaphors",
      "Pitch a movie idea in exactly 7 words",
      "Create a recipe for happiness (literal ingredients)",
      "Write a breakup letter to your phone",
      "Describe a color to someone who's never seen"
    ],
    funny: [
      "Write Yelp review for Earth from an alien tourist",
      "Create dating profile bio for a houseplant",
      "Write warning label for being an adult",
      "Pitch worst product idea that could actually sell",
      "Explain your job to a time traveler from 1823"
    ]
  };
  
  // State management
  let state = {
    streak: 0,
    totalPrompts: 0,
    level: 1,
    currentPrompt: "",
    currentCategory: "all",
    favorites: [],
    achievements: [],
    lastDate: null,
    theme: "default",
    leaderboard: [],
    lastBonus: null
  };
  
  // Check if we're in Farcaster environment with storage
  const hasStorage = typeof window.storage !== 'undefined';
  
  // Get user info from Farcaster context
  let currentUser = { fid: null, username: 'You', displayName: 'You' };
  let userStorageKey = 'dailyprompt-state'; // Will be updated with FID
  
  async function initUser() {
    if (window.frame?.sdk?.context) {
      try {
        const context = await window.frame.sdk.context;
        if (context?.user) {
          currentUser = {
            fid: context.user.fid,
            username: context.user.username || 'user',
            displayName: context.user.displayName || context.user.username || 'You'
          };
          // Create unique storage key per user
          userStorageKey = `dailyprompt-state-${currentUser.fid}`;
          console.log('‚úÖ User initialized:', currentUser);
          console.log('üì¶ Storage key:', userStorageKey);
        }
      } catch (err) {
        console.log('‚ö†Ô∏è Using default user (not in Farcaster)');
      }
    }
  }
  
  // DOM elements
  const el = {
    prompt: document.getElementById("prompt"),
    category: document.getElementById("promptCategory"),
    streakCount: document.getElementById("streakCount"),
    totalPrompts: document.getElementById("totalPrompts"),
    level: document.getElementById("level"),
    favoritesList: document.getElementById("favoritesList"),
    achievement: document.getElementById("achievement"),
    achievementText: document.getElementById("achievementText"),
    challengeModal: document.getElementById("challengeModal"),
    leaderboardModal: document.getElementById("leaderboardModal"),
    timer: document.getElementById("timer"),
    challengePrompt: document.getElementById("challengePrompt")
  };
  
  // Storage wrapper - now uses per-user keys
  async function loadState() {
    if (!hasStorage) {
      console.log('‚ö†Ô∏è Using in-memory storage (deploy to Farcaster for persistence)');
      return;
    }
    
    try {
      console.log('üìñ Loading state from:', userStorageKey);
      const saved = await window.storage.get(userStorageKey);
      
      if (saved && saved.value) {
        const data = JSON.parse(saved.value);
        // Merge saved data, keeping the structure intact
        state = {
          streak: data.streak || 0,
          totalPrompts: data.totalPrompts || 0,
          level: data.level || 1,
          currentPrompt: data.currentPrompt || "",
          currentCategory: data.currentCategory || "all",
          favorites: data.favorites || [],
          achievements: data.achievements || [],
          lastDate: data.lastDate || null,
          theme: data.theme || "default",
          leaderboard: data.leaderboard || [],
          lastBonus: data.lastBonus || null
        };
        console.log('‚úÖ State loaded successfully:', state);
      } else {
        console.log('üìù No saved state found, using fresh state');
      }
      
      // Load global leaderboard (shared across all users)
      const lb = await window.storage.get('dailyprompt-leaderboard', true);
      if (lb && lb.value) {
        state.leaderboard = JSON.parse(lb.value);
        console.log('üèÜ Leaderboard loaded:', state.leaderboard.length, 'users');
      }
    } catch (err) {
      console.error('‚ùå Load error:', err);
    }
  }
  
  async function saveState() {
    if (!hasStorage) return;
    
    try {
      console.log('üíæ Saving state to:', userStorageKey);
      await window.storage.set(userStorageKey, JSON.stringify(state));
      console.log('‚úÖ State saved successfully');
    } catch (err) {
      console.error('‚ùå Save failed:', err);
    }
  }
  
  async function updateLeaderboard() {
    if (!hasStorage) return;
    
    try {
      const lb = await window.storage.get('dailyprompt-leaderboard', true);
      let leaderboard = lb && lb.value ? JSON.parse(lb.value) : [];
      
      // Use actual Farcaster user info
      const userId = currentUser.fid || 'local';
      const userIndex = leaderboard.findIndex(u => u.id === userId);
      const userData = {
        id: userId,
        name: currentUser.displayName,
        username: currentUser.username,
        streak: state.streak,
        prompts: state.totalPrompts,
        level: state.level,
        score: state.streak * 10 + state.totalPrompts * 5
      };
      
      if (userIndex >= 0) {
        leaderboard[userIndex] = userData;
      } else {
        leaderboard.push(userData);
      }
      
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 10);
      
      await window.storage.set('dailyprompt-leaderboard', JSON.stringify(leaderboard), true);
      state.leaderboard = leaderboard;
      console.log('üèÜ Leaderboard updated');
    } catch (err) {
      console.error('‚ùå Leaderboard update failed:', err);
    }
  }
  
  function updateUI() {
    el.streakCount.textContent = state.streak;
    el.totalPrompts.textContent = state.totalPrompts;
    el.level.textContent = state.level;
    
    el.favoritesList.innerHTML = state.favorites.length === 0 
      ? '<p style="text-align:center;opacity:0.6;">No favorites yet</p>'
      : state.favorites.map((fav, i) => `
          <div class="favorite-item">
            <span>${fav}</span>
            <button class="delete-btn" onclick="deleteFavorite(${i})">‚úï</button>
          </div>
        `).join('');
  }
  
  function getRandomPrompt(category) {
    let pool = [];
    if (category === 'all') {
      pool = Object.values(prompts).flat();
    } else {
      pool = prompts[category] || [];
    }
    return pool[Math.floor(Math.random() * pool.length)];
  }
  
  function updateStreak() {
    const today = new Date().toISOString().slice(0, 10);
    if (state.lastDate !== today) {
      const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
      if (state.lastDate === yesterday) {
        state.streak++;
        checkAchievements('streak', state.streak);
      } else if (state.lastDate !== null) {
        state.streak = 1;
      } else {
        state.streak = 1;
      }
      state.lastDate = today;
    }
  }
  
  function checkAchievements(type, value) {
    const achievements = {
      streak: [
        { at: 3, msg: "3 Day Streak! You're on fire! üî•" },
        { at: 7, msg: "Week Warrior! 7 days strong! üí™" },
        { at: 30, msg: "Monthly Master! 30 days! üèÜ" }
      ],
      prompts: [
        { at: 10, msg: "10 Prompts! Getting creative! ‚ú®" },
        { at: 50, msg: "50 Prompts! Inspiration machine! üé®" },
        { at: 100, msg: "Century Club! 100 prompts! üëë" }
      ],
      level: [
        { at: 5, msg: "Level 5! Rising star! ‚≠ê" },
        { at: 10, msg: "Level 10! Creative genius! üåü" }
      ]
    };
    
    const checks = achievements[type] || [];
    checks.forEach(ach => {
      const key = `${type}_${ach.at}`;
      if (value === ach.at && !state.achievements.includes(key)) {
        state.achievements.push(key);
        showAchievement(ach.msg);
        launchConfetti();
      }
    });
  }
  
  function showAchievement(msg) {
    el.achievementText.textContent = msg;
    el.achievement.classList.add('show');
    setTimeout(() => el.achievement.classList.remove('show'), 3000);
  }
  
  function launchConfetti() {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const pieces = [];
    const colors = ['#f093fb', '#4facfe', '#00f2c3', '#ffd700', '#ff6bcb'];
    
    for (let i = 0; i < 100; i++) {
      pieces.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        rotation: Math.random() * 360,
        speed: 2 + Math.random() * 3,
        color: colors[Math.floor(Math.random() * colors.length)]
      });
    }
    
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pieces.forEach((p, i) => {
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-5, -5, 10, 10);
        ctx.restore();
        
        p.y += p.speed;
        p.rotation += 5;
        
        if (p.y > canvas.height) pieces.splice(i, 1);
      });
      
      if (pieces.length > 0) requestAnimationFrame(animate);
    }
    animate();
  }
  
  // Event listeners
  document.getElementById('surpriseBtn').addEventListener('click', () => {
    const prompt = getRandomPrompt(state.currentCategory);
    state.currentPrompt = prompt;
    
    el.prompt.style.opacity = 0;
    el.category.style.display = 'none';
    
    setTimeout(() => {
      el.prompt.textContent = prompt;
      el.category.textContent = state.currentCategory.toUpperCase();
      el.category.style.display = 'inline-block';
      el.prompt.style.opacity = 1;
      
      updateStreak();
      state.totalPrompts++;
      state.level = Math.floor(state.totalPrompts / 10) + 1;
      checkAchievements('prompts', state.totalPrompts);
      checkAchievements('level', state.level);
      updateUI();
      saveState();
      updateLeaderboard();
    }, 200);
  });
  
  document.getElementById('favoriteBtn').addEventListener('click', () => {
    if (state.currentPrompt && !state.favorites.includes(state.currentPrompt)) {
      state.favorites.push(state.currentPrompt);
      updateUI();
      saveState();
      showAchievement("Added to favorites! üíñ");
    }
  });
  
  document.getElementById('shareBtn').addEventListener('click', async () => {
    const shareText = state.currentPrompt 
      ? `"${state.currentPrompt}"\n\n‚ú® Get your daily prompt:` 
      : '‚ú® Get inspired with creative prompts daily!';
    
    // Check if we're in Farcaster environment
    if (window.frame?.sdk?.actions?.composeCast) {
      try {
        const result = await window.frame.sdk.actions.composeCast({
          text: shareText,
          embeds: ['https://farcaster.xyz/miniapps/vtK7pjPhFY8P/dailyprompt']
        });
        
        if (result?.cast) {
          showAchievement("Cast shared! üéâ");
        }
      } catch (err) {
        console.error('Cast error:', err);
        fallbackShare(shareText);
      }
    } else {
      fallbackShare(shareText);
    }
  });
  
  function fallbackShare(text) {
    if (navigator.share) {
      navigator.share({
        title: 'DailyPrompt',
        text: text
      });
    } else {
      navigator.clipboard.writeText(text);
      showAchievement("Copied to clipboard! üìã");
    }
  }
  
  window.deleteFavorite = (index) => {
    state.favorites.splice(index, 1);
    updateUI();
    saveState();
  };
  
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.currentCategory = btn.dataset.category;
      saveState();
    });
  });
  
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const theme = btn.dataset.theme;
      document.body.className = theme === 'default' ? '' : theme;
      state.theme = theme;
      saveState();
    });
  });
  
  let challengeInterval;
  document.getElementById('challengeBtn').addEventListener('click', () => {
    const prompt = getRandomPrompt('challenge');
    el.challengePrompt.textContent = prompt;
    el.timer.textContent = '60';
    el.challengeModal.classList.add('show');
  });
  
  document.getElementById('startChallenge').addEventListener('click', () => {
    let time = 60;
    const startBtn = document.getElementById('startChallenge');
    startBtn.disabled = true;
    startBtn.textContent = 'Challenge Running...';
    
    challengeInterval = setInterval(() => {
      time--;
      el.timer.textContent = time;
      
      if (time <= 0) {
        clearInterval(challengeInterval);
        showAchievement("Challenge complete! You're amazing! üéâ");
        launchConfetti();
        el.challengeModal.classList.remove('show');
        startBtn.disabled = false;
        startBtn.textContent = 'Start Challenge!';
        state.totalPrompts++;
        updateUI();
        saveState();
        updateLeaderboard();
      }
    }, 1000);
  });
  
  document.getElementById('closeChallenge').addEventListener('click', () => {
    clearInterval(challengeInterval);
    el.challengeModal.classList.remove('show');
    const startBtn = document.getElementById('startChallenge');
    startBtn.disabled = false;
    startBtn.textContent = 'Start Challenge!';
  });
  
  document.getElementById('leaderboardBtn').addEventListener('click', async () => {
    await updateLeaderboard();
    
    const leaderboardHTML = state.leaderboard.length > 0 
      ? state.leaderboard.map((user, i) => {
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
          const isCurrentUser = user.id === currentUser.fid || user.id === 'local';
          const displayName = isCurrentUser ? `${user.name} (You)` : user.name;
          const style = isCurrentUser ? 'background:rgba(240,147,251,0.2);' : '';
          
          return `
            <div class="leaderboard-item" style="${style}">
              <span>
                <span class="leaderboard-rank">${medal}</span> 
                ${displayName}
                ${user.username ? `<span style="opacity:0.7;font-size:0.9em;">@${user.username}</span>` : ''}
              </span>
              <span style="font-weight:700;">${user.score} pts</span>
            </div>
          `;
        }).join('')
      : '<p style="text-align:center;opacity:0.8;">Be the first on the leaderboard!</p>';
    
    document.getElementById('leaderboardList').innerHTML = leaderboardHTML;
    el.leaderboardModal.classList.add('show');
  });
  
  document.getElementById('closeLeaderboard').addEventListener('click', () => {
    el.leaderboardModal.classList.remove('show');
  });
  
  function checkDailyBonus() {
    const today = new Date().toISOString().slice(0, 10);
    const lastBonus = state.lastBonus || null;
    
    if (lastBonus !== today) {
      setTimeout(() => {
        showAchievement("Daily Bonus! +10 XP for coming back! üéÅ");
        state.lastBonus = today;
        saveState();
      }, 2000);
    }
  }
  
  // Initialize - IMPORTANT: Wait for everything to load properly
  async function init() {
    try {
      console.log('üöÄ Initializing app...');
      
      // Step 1: Get user info
      await initUser();
      
      // Step 2: Load their saved state
      await loadState();
      
      // Step 3: Update UI with loaded state
      updateUI();
      
      // Step 4: Apply saved theme
      if (state.theme && state.theme !== 'default') {
        document.body.className = state.theme;
        document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
        const themeBtn = document.querySelector(`[data-theme="${state.theme}"]`);
        if (themeBtn) themeBtn.classList.add('active');
      }
      
      // Step 5: Apply saved category
      if (state.currentCategory) {
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        const catBtn = document.querySelector(`[data-category="${state.currentCategory}"]`);
        if (catBtn) catBtn.classList.add('active');
      }
      
      // Step 6: Show last prompt if exists
      if (state.currentPrompt) {
        el.prompt.textContent = state.currentPrompt;
        el.category.textContent = state.currentCategory.toUpperCase();
        el.category.style.display = 'inline-block';
      }
      
      checkDailyBonus();
      console.log('‚úÖ App initialized successfully!');
      console.log('üìä Current state:', state);
    } catch (err) {
      console.error('‚ùå Initialization error:', err);
    }
  }
  
  // Run initialization
  init();
  
  // Auto-save every 30 seconds
  setInterval(saveState, 30000);
</script>
